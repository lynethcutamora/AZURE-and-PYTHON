CREATE EXTERNAL DATA SOURCE srcTestTable
WITH (
    LOCATION='https://lyndatalake.blob.core.windows.net/dlakecontainer'
);

CREATE EXTERNAL FILE FORMAT delimitedTextFileFormat
WITH(
    FORMAT_TYPE=DELIMITEDTEXT,
    FORMAT_OPTIONS(
        FIELD_TERMINATOR=',',
        FIRST_ROW=2
    )
);

CREATE EXTERNAL TABLE TestTable(
    [Name] VARCHAR(500),
    [Age] int,
    [Department] varchar(1000),
    [Email] varchar(1000)
)
WITH(
    LOCATION='/test_csv.csv',
    DATA_SOURCE=srcTestTable,
    FILE_FORMAT=delimitedTextFileFormat
)


SELECT * FROM TestTable



------------------- parquet

CREATE MASTER KEY ENCRYPTION BY PASSWORD='P@ssword@123'

CREATE DATABASE SCOPED CREDENTIAL sasToken
WITH IDENTITY='SHARED ACCESS SIGNATURE',
SECRET='sv=2022-11-02&ss=b&srt=sco&sp=rl&se=2025-02-06T18:23:05Z&st=2025-02-06T10:23:05Z&spr=https&sig=%2B6ajrXDte4H7IVkv41CBbxBhLWKUhWZkXxP%2BhUe1tfA%3D'

CREATE EXTERNAL DATA SOURCE srcActivityLog
WITH(
    LOCATION='https://lyndatalake.blob.core.windows.net/dlakecontainer/',
    CREDENTIAL=sasToken
);

CREATE EXTERNAL FILE FORMAT parquetFileFormat
WITH (
    FORMAT_TYPE=PARQUET,
    DATA_COMPRESSION='org.apache.hadoop.io.compress.SnappyCodec'
)


CREATE EXTERNAL TABLE ActivityLog(
    [Correlationid] VARCHAR(200),
    [Operationname] VARCHAR(300),
    [Status] VARCHAR(100),
    [Eventcategory] VARCHAR(100),
    [Level] VARCHAR(100),
    [Time] VARCHAR(100),
    [Subscription] VARCHAR(200),
    [Eventitiatedby] VARCHAR(1000),
    [ResourceType] VARCHAR(300),
    [ResourceGroup] VARCHAR(1000),
    [Resource] VARCHAR(2000)
)WITH(
    LOCATION='/ActivityLog01.parquet',
    DATA_SOURCE=srcActivityLog,
    FILE_FORMAT=parquetFileFormat
)


SELECT * FROM ActivityLog


--------------------- json

SELECT 
        JSON_VALUE(jsonContent,'$.Correlationid') AS Correlationid,
        JSON_VALUE(jsonContent, '$.Operationname') AS Operationname,
        JSON_VALUE(jsonContent, '$.Status') AS Status,
        JSON_VALUE(jsonContent, '$.Level') AS Level,
        CAST(JSON_VALUE(jsonContent,'$.Time') AS DATETIMEOFFSET) AS Time,
        JSON_VALUE(jsonContent, '$.Subscription') as Subscription,
        JSON_VALUE(jsonContent,'$.Eventinitatedby') AS Eventiatedby,
        JSON_VALUE(jsonContent, '$.Resourcetype') AS Resourcetype,
        JSON_VALUE(jsonContent, '$.Resourcegroup') AS Resourcegroup,
        JSON_VALUE(jsonContent, '$.Resource') AS Resource
FROM OPENROWSET(
    BULK 'https://lyndatalake.blob.core.windows.net/dlakecontainer/ActivityLog-01.json',
    FORMAT='csv',
    FIELDTERMINATOR='0x0b',
    FIELDQUOTE='0x0b',
    ROWTERMINATOR='0x0a'
)WITH(
    jsonContent VARCHAR(MAX)
)as rows